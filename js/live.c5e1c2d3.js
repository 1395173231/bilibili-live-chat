(function(){"use strict";var e={2313:function(e,t,n){var a=n(8764);window.Buffer=a.Buffer;var o=n(9963),s=n(6252),i=n(6612);function r(e,t,n,a,o,r){const l=(0,s.up)("danmaku-item"),c=(0,s.up)("live");return e.errMsg?((0,s.wg)(),(0,s.j4)(l,{key:0,type:"info",message:e.errMsg},null,8,["message"])):e.ready?((0,s.wg)(),(0,s.j4)(c,(0,i.vs)((0,s.dG)({key:1},e.props)),null,16)):(0,s.kq)("",!0)}var l=n(2262),c=n(8718),u=n.n(c),d=n(6604),m=n.n(d),f=n(7563);const p={room:"",anchor:"",cors:"false",face:"false",faceExpireDay:"",display:"bottom",stay:"",limit:"",giftComb:"",giftPin:"",delay:"",blockUID:"",debug:"",deeplToken:"",translateFrom:"",corsProxyUrl:"",translateTo:"PT-BR"};Object.freeze(p);const g=["room","anchor","faceExpireDay","stay","giftComb","limit","giftPin","delay"];Object.freeze(g);const h=new Set(g);Object.freeze(h);const v=e=>h.has(e),w={faceExpireDay:7};Object.freeze(w);const y=m()(p,((e,t)=>h.has(t)?Number:String));Object.freeze(y);const k={cors:[{value:"false",text:"关闭（所有跨域请求将依赖 codetabs，限制 5 请求/秒）"},{value:"true",text:"开启（请阅读右侧说明）"}],face:[{value:"false",text:"不显示"},{value:"gift",text:"仅对礼物显示，不需要额外调用 API"},{value:"true",text:"显示，通过 Bilibili API 获取（跨域）"},{value:"imjad",text:"显示，通过 HibiAPI 获取"}],display:[{value:"bottom",text:"自底部"},{value:"top",text:"从顶部"}]};Object.freeze(k);const b=e=>m()(u()({...p,...(0,f.parse)(e)},Object.keys(p)),((e,t)=>v(t)?e&&parseInt(e)||w[t]||0:t in k?k[t].some((({value:t})=>t===e))?e:p[t]:e||p[t]));var _=n(6154);let S=!0;const D=e=>S=e,T=e=>fetch(e,{referrer:"",referrerPolicy:"no-referrer",mode:"no-cors"}).then((e=>e.json())),P=e=>fetch(`https://api.codetabs.com/v1/proxy/?quest=${e}`).then((e=>e.json())),j=e=>S?T(e):P(e),x=_.Z.create({timeout:6e3});x.interceptors.request.use((e=>(localStorage._token&&(e.headers.Authorization=localStorage._token),e))),x.interceptors.response.use((e=>e),(e=>{if(e.response){let{status:t}=e.response;switch(t){case 404:console.error(e.response.message);break;case 500:console.error(e.response.statusText);break}}return Promise.reject(e)}));const L={get(e,t){return new Promise(((n,a)=>{x.get(e,t).then((e=>{e&&n(e.data)})).catch((e=>{a(e)}))}))},post(e,t,n){return new Promise(((a,o)=>{x.post(e,t,n).then((e=>{console.log(e),e&&a(e.data)})).catch((e=>{o(e)}))}))},delete(e,t){return new Promise(((n,a)=>{x.delete(e,{data:t}).then((e=>{e&&n(e.data)})).catch((e=>{a(e)}))}))},put(e,t){return new Promise(((n,a)=>{x.put(e,t).then((e=>{e&&n(e.data)})).catch((e=>{a(e)}))}))},fetch(e,t){return new Promise(((n,a)=>{fetch(e,t).then((e=>{e&&n(e.json())})).catch((e=>{a(e)}))}))}},O=async(e,t,n,a)=>{var o=new URLSearchParams;o.append("text",n),o.append("source_lang",e),o.append("target_lang",t);var s={method:"POST",headers:{Authorization:localStorage._token,"Content-Type":"application/x-www-form-urlencoded"},body:o,redirect:"follow"};return await L.fetch(a+"/https://api-free.deepl.com/v2/translate",s).then((e=>e))};var E=n(928),A=n.n(E),H=n(7204),F=n.n(H),M=n(3279),z=n.n(M),$=n(7247);const C=()=>Math.floor(Date.now()/864e5),I={method:"false",expireDay:7},R=e=>Object.assign(I,e),G=e=>{switch(I.method){case"imjad":return T(`https://api.obfs.dev/api/bilibili/v3/user_info?uid=${e}&size=1`).then((e=>{var t,n;return null===(t=e.data)||void 0===t||null===(n=t.card)||void 0===n?void 0:n.face}));default:return j(`https://api.bilibili.com/x/web-interface/card?mid=${e}`).then((e=>{var t,n;return null===(t=e.data)||void 0===t||null===(n=t.card)||void 0===n?void 0:n.face}))}},N=([e,t])=>{t||(t="member/noface.jpg");const n=A()(t.split(".")),a=`https://i${e}.hdslb.com/bfs/face/${t}`;return"gif"===n?[[a,0]]:[[`${a}_48x48.${n}`,2e3],[a,5e3]]},B=([,,e])=>!e||C()-e>=I.expireDay,U=new Map(Object.entries((0,$.M)("face",{})).filter((([,e])=>!B(e))).map((([e,t])=>[Number(e),t]))),q=z()((()=>(0,$.y)("face",F()(Array.from(U)))),5e3,{maxWait:5e3}),J=(e,t)=>{var n;if(!t)return;const a=parseInt(null===(n=/\/\/i(\d+)\./.exec(t))||void 0===n?void 0:n[1])||0,o=A()(t.split("/")),s=o.includes("noface")?[0,null,C()]:[a,o,C()];return U.set(e,s),q(),s},K=async e=>{const t=U.get(e);if(t&&!B(t))return N(t);try{return N(J(e,await G(e)))}catch(n){console.error("[face API error]",n)}return N([0,null])},Z={id:"live"};function Y(e,t,n,a,o,i){const r=(0,s.up)("danmaku-list");return(0,s.wg)(),(0,s.iD)("div",Z,[a.props.giftPin?((0,s.wg)(),(0,s.j4)(r,(0,s.dG)({key:0,ref:"giftPinList"},a.props,{"gift-show-face":a.giftShowFace,"is-gift-list":!0}),null,16,["gift-show-face"])):(0,s.kq)("",!0),(0,s.Wm)(r,(0,s.dG)({ref:"danmakuList"},a.props),null,16)])}var W=n(4171);const V={key:0,class:"danmaku-list-pinned",ref:"danmakuListRef"},X={class:"danmaku-list hidden"},Q={class:"danmaku-list absolute",ref:"giftListRef"},ee={key:1,class:"danmaku-list",ref:"danmakuListRef"},te={key:0,class:"danmaku-list-placeholder"};function ne(e,t,n,a,o,i){const r=(0,s.up)("danmaku-item");return n.isGiftList?((0,s.wg)(),(0,s.iD)("div",V,[(0,s._)("div",X,[((0,s.wg)(!0),(0,s.iD)(s.HY,null,(0,s.Ko)(e.giftPin,(e=>((0,s.wg)(),(0,s.j4)(r,{key:e,"show-face":n.giftShowFace,type:"gift",uname:"某人",giftName:"礼物",num:e},null,8,["show-face","num"])))),128))]),(0,s._)("div",Q,[((0,s.wg)(!0),(0,s.iD)(s.HY,null,(0,s.Ko)(a.danmakuList,(e=>((0,s.wg)(),(0,s.j4)(r,(0,s.dG)({key:e.key},e.props,{hidden:e.hidden,ref_for:!0,ref:t=>e.el=t}),null,16,["hidden"])))),128))],512)],512)):((0,s.wg)(),(0,s.iD)("div",ee,["bottom"===e.display?((0,s.wg)(),(0,s.iD)("div",te)):(0,s.kq)("",!0),((0,s.wg)(!0),(0,s.iD)(s.HY,null,(0,s.Ko)(a.danmakuList,(e=>((0,s.wg)(),(0,s.j4)(r,(0,s.dG)({key:e.key},e.props,{hidden:e.hidden,ref_for:!0,ref:t=>e.el=t}),null,16,["hidden"])))),128))],512))}var ae=n(2404),oe=n.n(ae),se=(n(7658),n(7632));const ie=(e,t)=>new Promise(((n,a)=>{let o=0;const s=new XMLHttpRequest,i=setTimeout((()=>{s.abort()}),1e4),r=t?setTimeout((()=>{0===o&&s.abort()}),t):null;s.open("GET",e,!0),s.onprogress=e=>{e.lengthComputable&&(o=e.loaded/e.total)},s.onload=()=>{clearTimeout(r),clearTimeout(i),n(e)},s.onerror=a,s.onabort=a,s.send()}));var re=async e=>{for(const[t,n]of e){const e=await ie(t,n).catch((()=>{console.warn("Timeout",t)}));if(e)return e}return e[0][0]||""};const le=["src"],ce={key:1,class:"danmaku-content"},ue={class:"danmaku-message"},de={key:2,class:"danmaku-content"},me=(0,s._)("span",{class:"danmaku-message"},"感谢 ",-1),fe={class:"danmaku-author-name"},pe=(0,s._)("span",{class:"danmaku-message"}," 赠送 ",-1),ge={class:"danmaku-gift-name"},he=(0,s._)("span",{class:"danmaku-message"}," × ",-1),ve={class:"danmaku-gift-num"},we={key:3,class:"danmaku-content"},ye=(0,s._)("span",{class:"danmaku-message"},"感谢 ",-1),ke={class:"danmaku-author-name"},be={class:"danmaku-message"},_e={key:4,class:"danmaku-content"},Se={class:"danmaku-message"};function De(e,t,n,a,o,r){return(0,s.wg)(),(0,s.iD)("div",{class:(0,i.C_)(["danmaku-item",{hidden:a.isHidden}])},[n.showFace?((0,s.wg)(),(0,s.iD)("img",{key:0,class:"danmaku-author-face",src:n.face},null,8,le)):(0,s.kq)("",!0),"message"===n.type?((0,s.wg)(),(0,s.iD)("div",ce,[(0,s._)("span",{class:(0,i.C_)(["danmaku-author-name with-colon",{anchor:n.isAnchor,owner:n.isOwner}])},(0,i.zw)(n.uname),3),(0,s._)("span",ue,(0,i.zw)(n.message),1)])):"gift"===n.type?((0,s.wg)(),(0,s.iD)("div",de,[me,(0,s._)("span",fe,(0,i.zw)(n.uname),1),pe,(0,s._)("span",ge,(0,i.zw)(n.giftName),1),he,(0,s._)("span",ve,(0,i.zw)(n.num),1)])):"sc"===n.type?((0,s.wg)(),(0,s.iD)("div",we,[ye,(0,s._)("span",ke,(0,i.zw)(n.uname),1),(0,s._)("span",be," 的SC："+(0,i.zw)(n.message),1)])):"info"===n.type?((0,s.wg)(),(0,s.iD)("div",_e,[(0,s._)("span",Se,(0,i.zw)(n.message),1)])):(0,s.kq)("",!0)],2)}var Te={props:{type:{type:String,default:"message"},showFace:Boolean,face:String,uid:Number,uname:String,message:String,isAnchor:Boolean,isOwner:Boolean,action:String,giftName:String,num:Number,stay:Number,hidden:Boolean},setup(e){const t=(0,l.iH)(!1),n=(0,l.iH)(!1);if(e.stay){const a=setTimeout((()=>{t.value=!0,"info"===e.type&&setTimeout((()=>n.value=!0),800)}),e.stay);(0,s.Jd)((()=>clearTimeout(a)))}const a=(0,s.Fl)((()=>e.hidden||t.value));return{...(0,l.BK)(e),isHidden:a,needRemoved:n}}},Pe=n(3744);const je=(0,Pe.Z)(Te,[["render",De]]);var xe=je;const Le=new Map;var Oe={components:{DanmakuItem:xe},props:{...y,isGiftList:Boolean,giftShowFace:Boolean},setup(e){let t=!0;(0,s.Jd)((()=>t=!1));const n=(0,l.iH)([]),a=(0,l.iH)(null),o=(0,l.iH)(null);(0,s.bv)((()=>{const e=a.value.getBoundingClientRect().top-5,t=()=>{const t=n.value.findIndex((t=>{var n,a,o,s;const{top:i=e,height:r=0}=null!==(n=null===(a=t.el)||void 0===a||null===(o=a.$el)||void 0===o?void 0:o.getBoundingClientRect())&&void 0!==n?n:{};return i<e&&(t.hidden=!0),i+r>e&&!(null!==(s=t.el)&&void 0!==s&&s.needRemoved)}));t>0&&n.value.splice(0,t)},o=setInterval(t,100);(0,s.Jd)((()=>clearInterval(o)))}));const i=()=>{const t=(0,l.SU)(e.isGiftList?o:a);t&&(t.scrollTop=t.scrollHeight)};e.isGiftList||((0,s.bv)((()=>window.addEventListener("resize",i))),(0,s.Jd)((()=>window.removeEventListener("resize",i))));const r=[],c=()=>{let e=200;const{length:a}=r;a>0&&(e=Math.min(e,1e3/a),n.value.push(r.shift()),(0,s.Y3)(i)),t&&setTimeout(c,e)};c();const u=async t=>{if(t.showFace){const e=await K(t.uid);let n,[a]=e.find((([e])=>n=Le.get(e)))||[""];a?!0!==n&&(a=await n):(n=re(e),Le.set(a,n),a=await n,Le.set(a,!0)),t.face=a}t.stay=t.stay||("bottom"===e.display?e.stay:0),r.push({props:t,key:(0,se.Z)(),el:null,hidden:!1})},d=[];if(e.limit){const t=setInterval((()=>{let t=d.splice(0);t.length&&(t.length>e.limit&&(t=oe()(Object.keys(t),e.limit).sort().map((e=>t[e]))),t.forEach((e=>u(e))))}),1e3);(0,s.Jd)((()=>clearInterval(t)))}const m=e=>d.push(e);return{...(0,l.BK)(e),danmakuList:n,danmakuListRef:a,giftListRef:o,addDanmaku:u,addSpeedLimitDanmaku:m}}};const Ee=(0,Pe.Z)(Oe,[["render",ne]]);var Ae=Ee,He={components:{DanmakuList:Ae},props:y,setup(e){const t=(0,l.iH)(null),n=(0,l.iH)(null),a=new Map,o=(0,s.Fl)((()=>!["false","gift"].includes(e.face))),i=(0,s.Fl)((()=>new Set(e.blockUID.split("|").map((e=>e.trim()))))),r=e=>i.value.has(String(e)),c=t=>{n.value.addDanmaku({type:"info",message:t,stay:e.stay||5e3})},u=t=>{e.limit?n.value.addSpeedLimitDanmaku(t):n.value.addDanmaku(t)};return(0,s.bv)((()=>{console.log("正在连接直播弹幕服务器");const i=new W.KeepLiveWS(e.room);(0,s.Jd)((()=>i.close())),i.on("open",(()=>{console.log("已连接直播弹幕服务器"),c("已连接直播弹幕服务器")})),i.on("live",(()=>{console.log("已连接直播间",e.room),c(`已连接直播间 ${e.room}`)})),i.on("close",(()=>console.log("已断开与直播弹幕服务器的连接"))),i.on("heartbeat",(e=>console.log("当前人气值",e)));const l=e.giftPin?t:n;i.on("SEND_GIFT",(({data:{uid:t,uname:n,action:o,giftName:s,num:i,face:c}})=>{if(r(t))console.log(`屏蔽了来自[${n}]的礼物：${s}*${i}`);else if(J(t,c),e.giftComb){const r=`${t}-${s}`,c=a.get(r);c?a.set(r,{...c,num:c.num+i}):(a.set(r,{type:"gift",showFace:"false"!==e.face,uid:t,uname:n,action:o,giftName:s,num:i}),setTimeout((()=>{l.value.addDanmaku(a.get(r)),a.delete(r)}),e.giftComb))}else l.value.addDanmaku({type:"gift",showFace:"false"!==e.face,uid:t,uname:n,action:o,giftName:s,num:i})})),i.on("DANMU_MSG",(async({info:[,t,[n,a,s]]})=>{if(r(n))return void console.log(`屏蔽了来自[${a}]的弹幕：${t}`);if(e.deeplToken){localStorage._token=`DeepL-Auth-Key ${e.deeplToken}`;let n=await O(e.translateFrom,e.translateTo,t,e.corsProxyUrl);t+="    "+e.translateTo+":"+n.translations[0].text}const i={type:"message",showFace:o.value,uid:n,uname:a,message:t,isAnchor:n===e.anchor,isOwner:!!s};e.delay>0?setTimeout((()=>u(i)),1e3*e.delay):u(i)})),i.on("SUPER_CHAT_MESSAGE",(async t=>{console.log("SUPER_CHAT_MESSAGE",t);let{data:{uid:n,user_info:{uname:a},message:o}}=t;if(e.deeplToken){localStorage._token=`DeepL-Auth-Key ${e.deeplToken}`;let t=await O(e.translateFrom,e.translateTo,o,e.corsProxyUrl);o+="/"+e.translateTo+":"+t.translations[0].text}l.value.addDanmaku({type:"sc",showFace:"false"!==e.face,uid:n,uname:a,message:o})})),window.giftList=l,i.on("SUPER_CHAT_MESSAGE_JPN",(e=>console.log("SUPER_CHAT_MESSAGE_JPN",e))),i.on("USER_TOAST_MSG",(t=>{const{data:{uid:n,username:a,role_name:o,num:s}}=t;l.value.addDanmaku({type:"gift",showFace:"false"!==e.face,uid:n,uname:a,giftName:o,num:s})}))})),{props:e,giftShowFace:o,giftPinList:t,danmakuList:n}}};const Fe=(0,Pe.Z)(He,[["render",Y]]);var Me=Fe,ze=(0,s.aZ)({components:{Live:Me,DanmakuItem:xe},setup(){const e=()=>window.location.reload();window.addEventListener("hashchange",e),(0,s.Jd)((()=>window.removeEventListener("hashchange",e)));const t=(0,l.qj)(b(window.location.hash)),n="true"===t.cors;D(n),R({method:t.face,expireDay:t.faceExpireDay});const a=(0,l.iH)(!1),o=(0,l.iH)("");return t.anchor?a.value=!0:j(`https://api.live.bilibili.com/room/v1/Room/room_init?id=${t.room}`).then((({code:e,msg:n,data:{room_id:s,uid:i}})=>{0===e?(t.room=parseInt(s),t.anchor=parseInt(i),a.value=!0):o.value=n})).catch((()=>{o.value="获取房间信息失败",n&&(o.value+="，请检查是否正确禁用了浏览器的 web security 以允许直接跨域")})),t.debug&&import("https://fastly.jsdelivr.net/npm/vconsole/dist/vconsole.min.js").then((()=>{new window.VConsole})),{props:t,ready:a,errMsg:o}}});const $e=(0,Pe.Z)(ze,[["render",r]]);var Ce=$e;(0,o.ri)(Ce).mount("#app")}},t={};function n(a){var o=t[a];if(void 0!==o)return o.exports;var s=t[a]={id:a,loaded:!1,exports:{}};return e[a].call(s.exports,s,s.exports,n),s.loaded=!0,s.exports}n.m=e,function(){var e=[];n.O=function(t,a,o,s){if(!a){var i=1/0;for(u=0;u<e.length;u++){a=e[u][0],o=e[u][1],s=e[u][2];for(var r=!0,l=0;l<a.length;l++)(!1&s||i>=s)&&Object.keys(n.O).every((function(e){return n.O[e](a[l])}))?a.splice(l--,1):(r=!1,s<i&&(i=s));if(r){e.splice(u--,1);var c=o();void 0!==c&&(t=c)}}return t}s=s||0;for(var u=e.length;u>0&&e[u-1][2]>s;u--)e[u]=e[u-1];e[u]=[a,o,s]}}(),function(){n.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return n.d(t,{a:t}),t}}(),function(){n.d=function(e,t){for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})}}(),function(){n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){n.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){n.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e}}(),function(){var e={576:0};n.O.j=function(t){return 0===e[t]};var t=function(t,a){var o,s,i=a[0],r=a[1],l=a[2],c=0;if(i.some((function(t){return 0!==e[t]}))){for(o in r)n.o(r,o)&&(n.m[o]=r[o]);if(l)var u=l(n)}for(t&&t(a);c<i.length;c++)s=i[c],n.o(e,s)&&e[s]&&e[s][0](),e[s]=0;return n.O(u)},a=self["webpackChunkbilibili_live_chat"]=self["webpackChunkbilibili_live_chat"]||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))}();var a=n.O(void 0,[64,639],(function(){return n(2313)}));a=n.O(a)})();